name: siscan-rpa

services:
  siscan:
    container_name: extrator-siscan-rpa
    image: ghcr.io/prisma-consultoria/siscan-rpa-rpa:main
    restart: unless-stopped
    environment:
      - PRODUCTION=true

      - SISCAN_USER=${SISCAN_USER}
      - SISCAN_PASSWORD=${SISCAN_PASSWORD}

      - RPA_MAX_ATTEMPTS=${RPA_MAX_ATTEMPTS:-3}
      
      - CRON_ENABLED=${CRON_ENABLED:-true}
      - CRON_INTERVAL_SECONDS=${CRON_INTERVAL_SECONDS:-1800}
      
      # Variáveis para arquivo Excel consolidado
      - HOST_CONSOLIDATED_EXCEL_FILENAME=${HOST_CONSOLIDATED_EXCEL_FILENAME:-monitoramento_mamografia.xlsx}
      - HOST_EXCEL_COLUMNS_MAPPING_FILENAME=${HOST_EXCEL_COLUMNS_MAPPING_FILENAME:-excel_columns_mapping.json}
    ports:
      - "${HOST_APP_EXTERNAL_PORT:-5001}:${APP_INTERNAL_PORT:-5000}"
    volumes:
      # Diretório raiz de mídia (contém downloads/ e reports/)
      # Estrutura esperada:
      #   /media/downloads/[PASTA-PERIODO]/extracao_laudo/
      #   /media/reports/mamografia/consolidado/
      #   /media/reports/mamografia/consolidado/exames/
      - "${HOST_MEDIA_ROOT:-./media}:/app/media"

      # Diretório de configuração (contém excel_columns_mapping.json)
      - "${HOST_EXCEL_COLUMNS_MAPPING_DIR:-./config}:/app/config"

    deploy:
      resources:
        limits:
          memory: 2G

    logging:
      driver: local

    healthcheck:
      test: ["CMD", "bash", "-lc", "curl -fsS http://127.0.0.1:${APP_INTERNAL_PORT:-5000}/health || exit 1"]
      interval: 15s
      timeout: 3s
      retries: 5

    # Se o cliente usar o Docker Desktop no Windows, eles devem apontar os
    # HOST_* variables (abaixo em .env.prd.sample) para paths no host Windows
    # (ex: C:\data\siscan\media ou /c/data/siscan/media dependendo do setup).
